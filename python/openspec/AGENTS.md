# AI Agent Guidelines

AI コーディングアシスタント向けのガイドライン。

## Workflow: BDD → OpenSpec → TDD

```
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: BDD (features/)                                   │
│  「何をすべきか」- ビジネス振る舞い                          │
│  ─────────────────────────────────────────────────────────  │
│  - Gherkin で受け入れ基準を定義                             │
│  - ステークホルダーが読める仕様書                            │
│  - AIへのガードレール・振る舞い入力として機能                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: OpenSpec (openspec/)                              │
│  「どう実装するか合意」- AI向け技術仕様                      │
│  ─────────────────────────────────────────────────────────  │
│  - proposal.md: BDDシナリオを参照しつつ技術仕様化           │
│  - tasks.md: 実装タスクを分解                               │
│  - specs/: 詳細スペック（型定義、API契約等）                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Phase 3: TDD (tests/)                                      │
│  「実装を検証」- エッジケース・境界値                        │
│  ─────────────────────────────────────────────────────────  │
│  - OpenSpecタスクに対応するユニットテスト                    │
│  - BDDでカバーしないエッジケース・境界値                     │
└─────────────────────────────────────────────────────────────┘
```

## AI Role by Phase

### Phase 1: BDD

| Do | Don't |
|----|-------|
| BDDシナリオを参照して要件を理解する | BDDシナリオを勝手に変更する |
| 不明点があればユーザーに確認する | 技術的な実装詳細をBDDに書く |
| 新しいビジネス要件の追加を提案する | 既存のシナリオを削除する |

### Phase 2: OpenSpec

| Do | Don't |
|----|-------|
| BDDシナリオへの参照を含める | BDDと矛盾する仕様を書く |
| 技術的な詳細を明文化する | 曖昧な記述を残す |
| タスクを小さく分解する | 依存関係を無視する |
| レビューを求める | 勝手に実装を開始する |

### Phase 3: TDD

| Do | Don't |
|----|-------|
| OpenSpecのタスクに対応するテストを書く | 仕様にないテストを追加する |
| エッジケース・境界値をカバーする | BDDと重複するテストを書く |
| Red → Green → Refactor を守る | テストなしで実装する |

## Decision Boundaries

### BDD vs OpenSpec

| Content | BDD | OpenSpec |
|---------|:---:|:--------:|
| ビジネスルール | ✅ | 参照 |
| ユーザーストーリー | ✅ | 参照 |
| 受け入れ基準 | ✅ | 参照 |
| 技術的制約 | - | ✅ |
| API設計 | - | ✅ |
| 実装タスク分解 | - | ✅ |

**原則**: BDD = What（何を）、OpenSpec = How（どう実装）

### OpenSpec vs TDD

| Content | OpenSpec | TDD |
|---------|:--------:|:---:|
| 型定義・API契約 | ✅ | - |
| エッジケース | 記載 | ✅ |
| 境界値テスト | - | ✅ |
| リファクタリング保護 | - | ✅ |

**原則**: OpenSpec = 仕様の明文化、TDD = 仕様の検証

## Prohibited Actions

1. **BDDシナリオの無断変更**
   - ビジネス要件の変更はステークホルダーとの合意が必要

2. **OpenSpec未レビューでの実装開始**
   - 技術仕様の合意前に実装を始めない

3. **TDDスキップ**
   - テストなしで実装コードをコミットしない

4. **境界違反**
   - 各層の責務を超えた記述をしない

## Commands

```bash
# BDD テスト実行
behave

# TDD テスト実行
pytest

# 全テスト実行
behave && pytest

# OpenSpec CLI
npm run openspec list --specs
npm run openspec list --changes
```

## File Locations

| Purpose | Location |
|---------|----------|
| BDD Scenarios | `features/*.feature` |
| Step Definitions | `features/steps/*.py` |
| OpenSpec Specs | `openspec/specs/*.md` |
| Change Proposals | `openspec/changes/*/` |
| Unit Tests | `tests/test_*.py` |
| Application Code | `src/*.py` |
